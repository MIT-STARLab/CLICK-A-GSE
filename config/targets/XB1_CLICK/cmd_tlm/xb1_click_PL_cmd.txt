#Author: Peter Grenfell, Sept 2020 (inherits code from DeMi_COSMOS_Interface.git)
#Reference: https://cosmosrb.com/docs/v4/command
#Internal Software Architecture Definitions: https://docs.google.com/document/d/1Js6CPJUfNAR2Xn8qK_whVCu2eVNNGZC8wcbRlzm1UGw/edit#heading=h.fk4yqm3vqev0 

#TBR: might not actually need to explicitly define many of these - see procedures/test_1.rb and procedures/fmt_cmd_click.rb ... seems to send arbitrary data on pre-defined payload write command

#1 Byte Test Command (Tested & Works)
COMMAND XACT EXAMPLE_PAYLOAD_COMMAND BIG_ENDIAN "Example one-byte command"
  APPEND_ID_PARAMETER SYNC_HI 32 UINT 0xBC7DECAF 0xBC7DECAF 0xBC7DECAF "Sync Pattern (high)"
    FORMAT_STRING "0x%08X"
  APPEND_ID_PARAMETER SYNC_LO 32 UINT 0xDECAFBC7 0xDECAFBC7 0xDECAFBC7 "Sync Pattern (low)"
    FORMAT_STRING "0x%08X"
  APPEND_ID_PARAMETER LEN 32 UINT 7 7 7 "Number of bytes following this in COSMOS command"
  APPEND_PARAMETER CCSDS_AP_ID 16 UINT 1 1 1 "CCSDS Ap Id"
  APPEND_PARAMETER AP_ID 8 UINT 15 15 15 "AP_ID of PAYLOAD_WRITE command"
  APPEND_PARAMETER OP_CODE 8 UINT 3 3 3 "Opcode of PAYLOAD_WRITE command"
  APPEND_PARAMETER CMD_LENGTH 16 UINT 1 1 1 "Length of bytes send to payload"
  APPEND_PARAMETER SINGLE_CMD_BYTE 8 UINT 0 255 1 “The only byte sent to payload”

#Configure Payload for Optical Downlink - RPi APID: 0x0500
COMMAND XACT CONFIG_OPTICAL_DOWNLINK BIG_ENDIAN "Configure the payload for optical downlink"
  APPEND_ID_PARAMETER SYNC_HI 32 UINT 0xBC7DECAF 0xBC7DECAF 0xBC7DECAF "Sync Pattern (high)"
    FORMAT_STRING "0x%08X"
  APPEND_ID_PARAMETER SYNC_LO 32 UINT 0xDECAFBC7 0xDECAFBC7 0xDECAFBC7 "Sync Pattern (low)"
    FORMAT_STRING "0x%08X"
  APPEND_ID_PARAMETER LEN 32 UINT 7 7 7 "Number of bytes following this in COSMOS command"
  APPEND_PARAMETER CCSDS_AP_ID 16 UINT 1 1 1 "CCSDS Ap Id"
  APPEND_PARAMETER AP_ID 8 UINT 15 15 15 "AP_ID of PAYLOAD_WRITE command"
  APPEND_PARAMETER OP_CODE 8 UINT 3 3 3 "Opcode of PAYLOAD_WRITE command"
  APPEND_PARAMETER CMD_LENGTH 16 UINT 4 4 4 "Length of bytes send to payload"
  #End header
  APPEND_PARAMETER RPI_AP_ID 16 UINT 0x0500 0x0500 0x0500 “RPi APID”
  APPEND_PARAMETER CH_SUM 16 UINT 0x0000 0xFFFF 0x0000 "16 bit checksum"

#Configure Payload for Debug Mode - RPi APID: 0x0501

#Get File - RPi APID: 0x0502 (Return an RPi file content)
COMMAND XACT PL_FILE_DWNLNK_REQ BIG_ENDIAN "Request File Downlink by name"
	APPEND_ID_PARAMETER SYNC_HI 32 UINT 0xBC7DECAF 0xBC7DECAF 0xBC7DECAF "Sync Pattern (high)"
	FORMAT_STRING "0x%08X"
	APPEND_ID_PARAMETER SYNC_LO 32 UINT 0xDECAFBC7 0xDECAFBC7 0xDECAFBC7 "Sync Pattern (low)"
	FORMAT_STRING "0x%08X"
	APPEND_ID_PARAMETER LEN 32 UINT 7 7 7 "Number of bytes following this in COSMOS command"
	APPEND_PARAMETER CCSDS_AP_ID 16 UINT 1 1 1 "CCSDS Ap Id"
	APPEND_PARAMETER AP_ID 8 UINT 15 15 15 "AP_ID of PAYLOAD_WRITE command"
	APPEND_PARAMETER OP_CODE 8 UINT 3 3 3 "Opcode of PAYLOAD_WRITE command"
	APPEND_PARAMETER CMD_LENGTH 16 UINT 256 256 256 "Length of bytes send to payload"
	# End header
	APPEND_PARAMETER RPI_AP_ID 16 UINT 0x0502 0x0502 0x0502 “RPi APID” #TBR bounds
	#TBD: timestamp txed ms #google doc
	#TBD: size #google doc
	#TBD: timestamp txed #google doc
	#TBD: payload #google doc
	APPEND_PARAMETER DIR_NAME_LEN 8 UINT 0x03 0x80 0x03 "Directory Name Length (128 char max, of 'path/to'--no slashes on ends)"
		UNITS Characters Characters
	APPEND_PARAMETER FILE_NAME_LEN 8 UINT 0x03 0x40 0x03 "File Name Length (64 char max, of 'file.fits')"
		UNITS Characters Characters
	APPEND_PARAMETER DIR_NAME 1536 STRING "" "Filename: path/to/file.fits"
	APPEND_PARAMETER PADDING 432 BLOCK '' "Padding for 256-byte packet"
	APPEND_PARAMETER CH_SUM 16 UINT 0x0000 0xFFFF 0x0000 "16 bit checksum"

	#DEMI:
	#APPEND_ID_PARAMETER PACK_ID 8 UINT 0xFD 0xFD 0xFD "Packet ID code" #TBR - might be useful for string input...
	#	FORMAT_STRING "0x%02X"
	#APPEND_PARAMETER CMD_SRC 8 UINT 0xCC 0xCC 0xCC "Command source. 0xCC is from COSMOS, not from BCT macros" #internal defn
	#APPEND_PARAMETER CMD_SEQ 16 UINT 0x00 0xFFFF 0x00 "Command Sequence Number" #internal defn
	#APPEND_PARAMETER DEL_WHEN_ACKD 8 UINT 0x00 0xFF 0x00 "Delete when gnd-receipt acknowledged?"
	#	STATE YES 0xFF
	#	STATE NO 0x00

#Push File - RPi APID: 0x0503 (Write an RPi file) [TBR - DeMi_COSMOS_Interface.git]
COMMAND XACT PL_UPLOAD_FILE_TOSTAGING BIG_ENDIAN "Upload File to Staging" #New packet size is less than 1002, making it 1000 
	APPEND_ID_PARAMETER SYNC_HI 32 UINT 0xBC7DECAF 0xBC7DECAF 0xBC7DECAF "Sync Pattern (high)"
	FORMAT_STRING "0x%08X"
	APPEND_ID_PARAMETER SYNC_LO 32 UINT 0xDECAFBC7 0xDECAFBC7 0xDECAFBC7 "Sync Pattern (low)"
	FORMAT_STRING "0x%08X"
	APPEND_ID_PARAMETER LEN 32 UINT 7 7 7 "Number of bytes following this in COSMOS command"
	APPEND_PARAMETER CCSDS_AP_ID 16 UINT 1 1 1 "CCSDS Ap Id"
	APPEND_PARAMETER AP_ID 8 UINT 15 15 15 "AP_ID of PAYLOAD_WRITE command"
	APPEND_PARAMETER OP_CODE 8 UINT 3 3 3 "Opcode of PAYLOAD_WRITE command"
	APPEND_PARAMETER CMD_LENGTH 16 UINT 950 950 950 "Length of bytes send to payload"
	# End header
	APPEND_PARAMETER RPI_AP_ID 16 UINT 0x0503 0x0503 0x0503 “RPi APID” #TBR bounds
	APPEND_PARAMETER PL_SIZE 16 UINT 0x00 0x03DA 0x00 "Payload Size" LITTLE_ENDIAN
	APPEND_PARAMETER OVERWRITE 8 UINT 0x00 0xFF 0x00 "Overwrite data?"
		STATE NO 0x00
		STATE YES 0xFF
	APPEND_ARRAY_PARAMETER DATA 8 UINT 7472 "Data"
	APPEND_PARAMETER CH_SUM 16 UINT 0x00 0xFFFF 0x00 "16 bit checksum"

	#DEMI:
	#APPEND_PARAMETER LENGTH 16 UINT 950 950 950 "Number of bytes in RawBytes"  # despite the bus's spec that this can be 1002, it had indeterminate behavior at 1000
	#UNITS bytes bytes
	#APPEND_ID_PARAMETER PACK_ID 8 UINT 0xF1 0xF1 0xF1 "Packet ID code"
	#FORMAT_STRING "0x%02X"
	#APPEND_PARAMETER CMD_SRC 8 UINT 0xCC 0xCC 0xCC "Command source. 0xCC is from COSMOS, not from BCT macros"
	#APPEND_PARAMETER CMD_SEQ 16 UINT 0x0000 0xFFFF 0x0000 "Command Sequence Number"
	#APPEND_PARAMETER TRANS_ID 16 UINT 0x00 0xFFFF 0x00 "Transfer ID" LITTLE_ENDIAN
	#APPEND_PARAMETER TOT_PACKETS_NUM 16 UINT 0x00 0xFFFF 0x00 "Total Packets #" LITTLE_ENDIAN
	#APPEND_PARAMETER FILE_SEQ_NUM 16 UINT 0x00 0xFFFF 0x00 "File Sequence #" LITTLE_ENDIAN

#Get PAT History - RPi APID: 0x0504 (Request buffer (history) of PAT data, for ground performance analysis)

#Set FPGA Memory Map Values - RPi APID: 0x0505 (Address (4B, 4B alligned), Data (size multiples of 4B) -> Ok/Not OK)

#Set Time - RPi APID: 0x0506 (Set payload time using GPS from bus, so telemetry can be requested with relevant ranges)

#Get Errors and Events - RPi APID: 0x0507 (Return all errors between 2 UTC times)

#Get Housekeeping Data - RPi APID: 0x0508 (Return a given number of housekeeping packets after a given UTC time)

#Get Telemetry Packet - RPi APID: 0x0509 (Return a given number of telemetry packets of a certain type after a given UTC time)

#Get FPGA Memory Map Values - RPi APID: 0x0510 (Address (4B, 4B alligned), range (multiples of 4) -> Values)

#Request Telemetry - RPi APID: 0x0511 

#Turn On Subsystem - RPi APID: 0x0512

#Turn Off Subsystem - RPi APID: 0x0513

#Change Payload Mode - RPi APID: 0x0514

#Execute File - RPi APID: 0x0515 TBR

#Current Bus Mode - RPi APID: 0x0516

#Echo - RPi APID: 0x0517

#No-op - RPi APID: 0x0518